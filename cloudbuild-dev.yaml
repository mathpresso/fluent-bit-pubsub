steps:
  # Step 1: make.sh 실행을 위한 bash + docker 이미지
  - name: 'gcr.io/cloud-builders/docker'
    entrypoint: 'bash'
    args: ['make.sh', 'build']
    dir: '.'

  # ✅ Step 2: Docker buildx 빌드
  - name: 'gcr.io/cloud-builders/docker'
    args:
      [
        'buildx', 'build',
        '--platform=linux/amd64',
        '-f', 'docker/Dockerfile',
        '-t', 'asia-northeast3-docker.pkg.dev/mp-artifact-registry-aa49/devops/qanda/fluent-bit:3.2.10-pubsub',
        '--push',
        '.'
      ]
    env:
      - DOCKER_CLI_EXPERIMENTAL=enabled
    entrypoint: 'docker'

timeout: 1200s
options:
  machineType: 'E2_HIGHCPU_8'
